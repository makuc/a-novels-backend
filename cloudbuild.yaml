steps:
# Decrypt the file containing the access token
- name: 'gcr.io/cloud-builders/gcloud'
  args:
  - kms
  - decrypt
  - --ciphertext-file=git-credentials.enc
  - --plaintext-file=/root/.git-credentials
  - --location=global
  - --keyring=github-keyring
  - --key=github-token
  volumes:
  - name: 'git-access'
    path: /root

# Set up git with key and domain.
- name: 'gcr.io/cloud-builders/git'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    git config --global user.email "armin.makovec@hotmail.com"
    git config --global user.name "Armin Makovec"
    git config --global credential.helper store --store=/root/git-credentials
    git clone https://makuc:5612ec3ddb444beabedee0444b251f0a4e9fac45@github.com/makuc/diploma.git
    rm -fr diploma
  volumes:
  - name: 'git-access'
    path: /root

# Test Credentials by Cloning a Repo
- name: 'gcr.io/cloud-builders/git'
  args:
  - clone
  - https://github.com/makuc/diploma.git
  volumes:
  - name: 'git-access'
    path: /root

- name: 'gcr.io/cloud-builders/gcloud'
  args:
  - alpha
  - functions
  - deploy
  - ${_PREFIX}-func1
  - --trigger-http
  - --entry-point=BrezBaze
  - --runtime=go111
  - --memory=128MB
#  - --source=${_REPO}
  dir: 'functions/noDBExp'
  volumes:
  - name: 'git-access'
    path: /root